<!DOCTYPE html>
<html>
<head>
    <title>IIIF 3D Manifest Loader</title>
        <script type='text/javascript' charset="UTF-8" src='https://x3dom.org/release/x3dom-full.js'> </script>         
        <link rel='stylesheet' type='text/css' href='https://x3dom.org/release/x3dom.css'></link> 
        <script type='text/javascript' charset="UTF-8" src='manifest_3d_tools.js'> </script>  
        <style>
            body {font-size:12pt}
            
            .canvas-width {width:960px;}
            .canvas-height {height:512px; }
            x3d
            {
                border:2px solid black;
            }
        </style>
<script src='manifesto.js' type="application/javascript"></script>
<script>


function fit_view()
{
    /*
    This code for setting a view to show everything
    after the model has downloaded was suggested
    by discussion in https://github.com/x3dom/x3dom/issues/632
    */
    console.log("call into fit_view")
    x3d_element = document.getElementById("x3delem");
    
    
              
            x3d_element.runtime.showAll();
            x3d_element.addEventListener("downloadsfinished",
                function()
                {
                    x3d_element.runtime.showAll();
                }
            );
        
}


function LoadAnnotationsRecursive(iterator)
{	
	
	function func()
	{
		
	}
}

// generator function
function* AnnotationsFromManifest( manifest )
{
	for (const seq of manifest.getSequences())
	{
		const canv = seq.getCanvases()[0];
		for (const anno of canv.getContent()) yield anno;
	}
}

function LoadOneAnnotation(anno)
{
	var inlineElem = document.createElement('inline');
	var target = anno.getTarget();
	var body = anno.getBody()[0];
	
	var outerElement = undefined;
	if (target.IsSpecificResource && target.getSelector().IsPointSelector )
	{
		
		var sel = target.getSelector();
		
		var loc = target.getSelector().getLocation();
		
		outerElement = document.createElement('transform');
		var positionString = `${loc.x} ${loc.y} ${loc.z}`
		
		outerElement.setAttribute("translation", positionString)
		outerElement.appendChild(inlineElem);
	}
	else
		outerElement = inlineElem;
		
	console.log("set to load " + body.id);
	
	//inlineElem.setAttribute('onload', 'fit_view()');
	
	var inline_container = document.getElementById( "inline-container");
	if (inline_container)
	{
		inline_container.appendChild(outerElement);
		//inlineElem.addEventListener('load', fit_view);
		inlineElem.setAttribute('url', body.id);
	}
	else console.warn("inline-container not found");
}

function load_manifest()
{
    manifest_url_field = document.getElementById("manifest_url");
    var manifest_url = manifest_url_field.value;
    
    manifesto.loadManifest(manifest_url).then( (maanifest_json) => 
	{
    	const manifest = manifesto.parseManifest(maanifest_json);
    	var label = manifest.getLabel().getValue("en");
    	console.log("loaded manifest " + label);
    	//var iterator = AnnotationsFromManifest(manifest);
    	
    	for (var anno of AnnotationsFromManifest(manifest))
    	{
    		LoadOneAnnotation(anno);
    	}
    	fit_view();
    	var inline_container = document.getElementById( "inline-container");
    	console.log(inline_container.innerHTML);
    	//var anno0iter = iterator.next();
    	//if (anno0iter.done)
    	//{
    	//	console.log("no annotations found");
    	//}
    	//else
    	//{
    		
    	//	fit_view();
    	//}
	}).catch( (error) => { console.warn("manifesto error: " + error)});
}


function load_manifest_view( aManifest )
{
    manifest_view = document.querySelector("#manifest_view");
    
    if (aManifest.requiredStatement && aManifest.requiredStatement.value)
    {
        p = document.createElement("p");
        p.appendChild( document.createTextNode( aManifest.requiredStatement.value.en[0] ));
        manifest_view.appendChild(p)
    }
}

window.addEventListener("load" , (event) => 
{
    const  schparams = new URLSearchParams(window.location.search);
    manifest_url_field = document.getElementById("manifest_url");
    manifest_url_field.value = schparams.get('url');
    
});


//x3dom.runtime.ready = function() { load_annotation_body("https://rpm-collections.s3.eu-west-2.amazonaws.com/e4fd82cfa63942218e1568a28efe46db.glb"); }
</script>
</head>
<body>
        <div class="canvas-width" style="text-align:center; font-size:16pt">Load 3D Model referenced in 3D Manifest</div>
        
        <div style="margin:1em;">
        
	<tr>
		<td>URL to 3D-ish manifest</td>
		<td>
		<input 
		        style="width:60%;" type="url" id="manifest_url" 
                        value="https://www.rpm-api.io/records/5e7de766317ed200177bdeb7?_format=iiif"/>
        </td>
		<td><button type="button" onclick="load_manifest()">Load Manifest</button> </td>
	</tr>
</table>

        </table>
        </div>
        <div class="canvas-width canvas-height" style="margin-bottom:0px;">
        <x3d id="x3delem" class="canvas-width canvas-height"> 
        <scene>
        <navigationinfo headlight='true'></navigationinfo>
        <background skyColor="0.8 0.8 0.8"></background>
        <viewpoint position="0 0 10" orientation="0 0 1 0" 
	     centerOfRotation="0 0 0" ></viewpoint>
	     <transform id="inline-container" scale="1 1 1">
	    
	    </transform>
    </scene>
        </x3d> 
        </div>
    
    
<div id="manifest_view"> </div>

       
      
        
</body>
</html>
